{% if leads is empty %}
<div class="text-center py-4">
    <i class="bi bi-list-ul text-muted" style="font-size: 2rem;"></i>
    <h6 class="text-muted mt-2">Brak leadów</h6>
    <p class="text-muted mb-0">Ten klient nie ma jeszcze żadnych leadów.</p>
</div>
{% else %}
<!-- Leads Summary Cards -->
<div class="row g-2 mb-3">
    <div class="col-3">
        <div class="card bg-primary text-white text-center">
            <div class="card-body py-2">
                <div class="h6 mb-1">{{ newLeads }}</div>
                <small>Nowe</small>
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="card bg-info text-white text-center">
            <div class="card-body py-2">
                <div class="h6 mb-1">{{ contactedLeads }}</div>
                <small>Skontaktowane</small>
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="card bg-warning text-white text-center">
            <div class="card-body py-2">
                <div class="h6 mb-1">{{ qualifiedLeads }}</div>
                <small>Zakwalifikowane</small>
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="card bg-success text-white text-center">
            <div class="card-body py-2">
                <div class="h6 mb-1">{{ convertedLeads }}</div>
                <small>Przekonwertowane</small>
            </div>
        </div>
    </div>
</div>

<!-- Leads List -->
<div class="leads-list">
    {% for lead in leads %}
    <div class="card mb-2">
        <div class="card-body py-2">
            <div class="row align-items-center">
                <!-- Lead Status -->
                <div class="col-2">
                    <span class="badge bg-{{ lead.status == 'new' ? 'primary' : (lead.status == 'contacted' ? 'info' : (lead.status == 'qualified' ? 'warning' : (lead.status == 'converted' ? 'success' : 'secondary'))) }}">
                        {{ lead.statusLabel }}
                    </span>
                </div>
                
                <!-- Lead Info -->
                <div class="col-6">
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                            <i class="bi bi-building text-muted"></i>
                        </div>
                        <div>
                            <div class="fw-bold">{{ lead.applicationName }}</div>
                            {% if lead.property.location %}
                            <small class="text-muted">{{ lead.property.location }}</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Lead Date -->
                <div class="col-2">
                    <small class="text-muted">
                        <i class="bi bi-calendar me-1"></i>
                        {{ lead.createdAt|date('d.m.Y') }}
                    </small>
                </div>
                
                <!-- Lead Price -->
                <div class="col-2">
                    {% if lead.property.price %}
                    <div class="text-end">
                        <strong class="text-success">
                            {{ lead.property.price|number_format(0, ',', ' ') }} zł
                        </strong>
                    </div>
                    {% else %}
                    <div class="text-end text-muted">
                        <small>-</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Lead Details (Expandable) -->
            <div class="row mt-2" id="lead-details-{{ lead.id }}" style="display: none;">
                <div class="col-12">
                    <div class="border-top pt-2">
                        <div class="row g-2">
                            <div class="col-6">
                                <small class="text-muted">
                                    <strong>UUID:</strong> {{ lead.leadUuid }}
                                </small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">
                                    <strong>Status CDP:</strong> 
                                    <span class="badge bg-secondary">{{ lead.cdpDeliveryStatus }}</span>
                                </small>
                            </div>
                            {% if lead.property.location %}
                            <div class="col-12">
                                <small class="text-muted">
                                    <strong>Lokalizacja:</strong> {{ lead.property.location }}
                                </small>
                            </div>
                            {% endif %}
                            {% if lead.property.city %}
                            <div class="col-12">
                                <small class="text-muted">
                                    <strong>Miasto:</strong> {{ lead.property.city }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lead Actions -->
            <div class="row mt-2">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="button" 
                                class="btn btn-outline-secondary btn-sm"
                                onclick="toggleLeadDetails({{ lead.id }})">
                            <i class="bi bi-chevron-down me-1"></i>
                            <span id="toggle-text-{{ lead.id }}">Szczegóły</span>
                        </button>
                        
                        <div class="d-flex gap-1">
                            <button type="button" 
                                    class="btn btn-outline-primary btn-sm"
                                    onclick="viewLeadDetails({{ lead.id }})"
                                    title="Zobacz szczegóły leada">
                                <i class="bi bi-eye"></i>
                            </button>
                            {% if is_granted('ROLE_CALL_CENTER') %}
                            <button type="button" 
                                    class="btn btn-outline-danger btn-sm"
                                    onclick="console.log('Delete button clicked for lead:', {{ lead.id }}); loadDeleteModal({{ lead.id }}, '{{ lead.leadUuid }}')"
                                    title="Usuń lead">
                                <i class="bi bi-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Load More Button (if needed) -->
{% if totalLeads > leads|length %}
<div class="text-center mt-3">
    <button type="button" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-arrow-down me-1"></i>
        Załaduj więcej leadów
    </button>
</div>
{% endif %}

<!-- Leads Summary -->
<div class="mt-3 p-2 bg-light rounded">
    <div class="row text-center">
        <div class="col-12">
            <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Wyświetlane {{ leads|length }} z {{ totalLeads }} leadów
            </small>
        </div>
    </div>
</div>
{% endif %}

<script>
function toggleLeadDetails(leadId) {
    const details = document.getElementById(`lead-details-${leadId}`);
    const toggleText = document.getElementById(`toggle-text-${leadId}`);
    const button = toggleText.parentElement;
    
    if (details.style.display === 'none') {
        details.style.display = 'block';
        toggleText.textContent = 'Ukryj';
        button.innerHTML = '<i class="bi bi-chevron-up me-1"></i>Ukryj';
    } else {
        details.style.display = 'none';
        toggleText.textContent = 'Szczegóły';
        button.innerHTML = '<i class="bi bi-chevron-down me-1"></i>Szczegóły';
    }
}
